# govaluate 使用示例

演示 `github.com/Knetic/govaluate` 包的常用功能和使用场景。

## 什么是 govaluate？

`govaluate` 是一个 Go 语言的表达式求值库，可以在运行时解析和计算字符串表达式。它支持数学运算、逻辑判断、字符串操作等多种功能。

## 主要特性

- **数学运算**: 支持基本的四则运算、幂运算、取模等
- **逻辑运算**: 支持 &&、||、! 等逻辑操作符
- **比较运算**: 支持 ==、!=、>、<、>=、<= 等比较操作符
- **变量替换**: 可以在表达式中使用变量
- **条件表达式**: 支持三元运算符 ? :
- **字符串操作**: 支持字符串连接、长度计算等
- **自定义函数**: 可以注册自定义函数
- **类型安全**: 自动处理类型转换

## 常见使用场景

1. **配置驱动的业务规则**: 将业务规则写成表达式存储在配置中
2. **动态计算**: 根据用户输入动态计算结果
3. **条件判断**: 复杂的条件逻辑判断
4. **价格计算**: 电商场景中的价格、折扣计算
5. **权限控制**: 基于表达式的权限验证
6. **数据验证**: 动态的数据验证规则

## 支持的操作符

### 数学操作符
- `+` 加法
- `-` 减法  
- `*` 乘法
- `/` 除法
- `%` 取模
- `**` 幂运算

### 比较操作符
- `==` 等于
- `!=` 不等于
- `>` 大于
- `<` 小于
- `>=` 大于等于
- `<=` 小于等于

### 逻辑操作符
- `&&` 逻辑与
- `||` 逻辑或
- `!` 逻辑非

### 其他操作符
- `? :` 三元条件运算符
- `()` 括号改变优先级

## 内置函数

- `abs(x)` 绝对值
- `sqrt(x)` 平方根
- `len(s)` 字符串长度
- `substr(s, start, length)` 子字符串

## expr.Vars() 方法详解

`expr.Vars()` 是一个非常实用的方法，用于获取表达式中使用的所有变量名。

### 基本用法

```go
expression, err := govaluate.NewEvaluableExpression("price * quantity * (1 - discount)")
if err != nil {
    log.Fatal(err)
}

// 获取表达式中的所有变量
variables := expression.Vars()
fmt.Println(variables) // 输出: [price quantity discount]

// 遍历变量
for _, varName := range variables {
    fmt.Printf("变量: %s\n", varName)
}
```

### 实际应用场景

1. **动态参数构建**: 根据表达式自动构建所需的参数映射
2. **API 文档生成**: 自动分析接口需要哪些参数
3. **表单验证**: 分析验证规则依赖的字段
4. **配置管理**: 了解业务规则依赖的数据源
5. **依赖分析**: 分析表达式之间的数据依赖关系

### 注意事项

- 返回的变量名数组可能包含重复项（如 `age >= 18 && age <= 120` 会返回 `[age age]`）
- 变量名区分大小写
- 只返回变量名，不包含常量和函数名

## 运行示例

```bash
cd govaluate-demo
go run main.go
```

## 示例说明

### 1. 基本数学表达式
演示基本的数学运算，包括四则运算、幂运算、内置数学函数等。

### 2. 变量替换
展示如何在表达式中使用变量，适用于动态计算场景。

### 3. 逻辑表达式
演示逻辑运算符的使用，常用于条件判断。

### 4. 字符串操作
展示字符串相关的操作，如连接、长度计算等。

### 5. 条件表达式
演示三元运算符的使用，实现条件分支逻辑。

### 6. 自定义函数
展示如何注册和使用自定义函数，扩展表达式的功能。

### 7. 表达式变量分析
演示如何使用 `expr.Vars()` 方法获取表达式中使用的所有变量名，这对于：
- 动态构建参数映射
- 表单验证规则分析
- 配置驱动的业务规则管理
- API 参数依赖分析
非常有用。

### 8. 复杂业务场景
实际的业务场景示例，包括电商价格计算和权限验证。

## 最佳实践

1. **表达式缓存**: 对于重复使用的表达式，建议缓存编译后的 `EvaluableExpression` 对象
2. **错误处理**: 始终检查表达式解析和计算的错误
3. **类型安全**: 确保传入的参数类型正确
4. **性能考虑**: 复杂表达式可能有性能开销，注意在高频场景中的使用
5. **安全性**: 如果表达式来自用户输入，需要考虑安全性问题

## 注意事项

- 变量名区分大小写
- 字符串需要用单引号包围
- 数字支持整数和浮点数
- 布尔值使用 `true` 和 `false`
- 表达式解析是一次性的，可以多次求值

简单、强大、灵活的表达式求值库，适用于需要动态计算的各种场景。
